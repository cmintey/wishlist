<script lang="ts">
    import { quintOut } from "svelte/easing";
    import { crossfade } from "svelte/transition";
    import { flip } from "svelte/animate";
    import type { PageData } from "./$types";
    import ItemCard, { type FullItem } from "$lib/components/wishlists/ItemCard/ItemCard.svelte";
    import noClaims from "$lib/assets/no_claims.svg";
    import { t } from "svelte-i18n";
    import { groupBy } from "$lib/util";

    interface Props {
        data: PageData;
    }

    let { data }: Props = $props();
    let items = $state(data.items);

    const [send, receive] = crossfade({
        duration: (d) => Math.sqrt(d * 200),

        fallback(node) {
            const style = getComputedStyle(node);
            const transform = style.transform === "none" ? "" : style.transform;

            return {
                duration: 600,
                easing: quintOut,
                css: (t) => `
					transform: ${transform} scale(${t});
					opacity: ${t}
				`
            };
        }
    });

    let groupedItems = $derived.by(() => {
        const unpurchasedItems: FullItem[] = [];
        const purchasedItems: FullItem[] = [];
        items.forEach((item) => (item.purchased ? purchasedItems.push(item) : unpurchasedItems.push(item)));
        return groupBy([...unpurchasedItems, ...purchasedItems], (item) => item.user?.name);
    });
</script>

{#if data.items.length === 0}
    <div class="flex flex-col items-center justify-center space-y-4 pt-4">
        <img class="w-3/4 md:w-1/3" alt={$t("a11y.a-person-looking-at-an-empty-board")} src={noClaims} />
        <p class="text-2xl">{$t("wishes.nothing-claimed-yet")}</p>
    </div>
{:else}
    <div class="flex flex-col space-y-4">
        {#each groupedItems.entries() as group (group[0])}
            {@const items = group[1]}
            <div class="flex flex-row items-center space-x-2">
                <p class="text-xl font-bold">{group[0]}</p>
                <hr class="flex-grow rounded !border-4" />
            </div>
            {#each items as item (item.id)}
                <div in:receive={{ key: item.id }} out:send|local={{ key: item.id }} animate:flip={{ duration: 200 }}>
                    <ItemCard {item} showClaimedName showFor user={data.user} />
                </div>
            {/each}
        {/each}
    </div>
{/if}

<svelte:head>
    <title>{$t("app.my-claims")}</title>
</svelte:head>
